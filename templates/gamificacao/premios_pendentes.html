{% extends 'base.html' %}
{% load static %}

{% block title %}üéÅ Pr√™mios Pendentes - Sistema de Gamifica√ß√£o{% endblock %}

{% block content %}
<div class="container-fluid px-4">
    <div class="row mb-4">
        <div class="col-12 d-flex justify-content-between align-items-center">
            <h1 class="cyberpunk-title">
                <span class="neon-text">üéÅ PR√äMIOS PENDENTES</span>
            </h1>
            <div class="btn-group">
                <a href="{% url 'caca_niquel' %}" class="btn btn-primary btn-lg">
                    üé∞ Ca√ßa-N√≠quel
                </a>
                <a href="{% url 'historico_caca_niquel' %}" class="btn btn-info btn-lg">
                    üìä Hist√≥rico
                </a>
            </div>
        </div>
    </div>
    
    <!-- Contador de Pr√™mios Pendentes -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="cyberpunk-card text-center">
                <h2 class="neon-text mb-3">
                    ‚è≥ {{ premios.count }} Pr√™mio{{ premios.count|pluralize }} Aguardando Resgate
                </h2>
                {% if premios.count > 0 %}
                    <p class="text-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        N√£o se esque√ßa de entregar os pr√™mios aos alunos!
                    </p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Lista de Pr√™mios Pendentes -->
    <div class="row">
        {% for premio in premios %}
            <div class="col-lg-6 col-xl-4 mb-4">
                <div class="premio-card 
                    {% if premio.recompensa == '10_reais' %}premio-dourado
                    {% elif premio.recompensa == '5_reais' %}premio-prata  
                    {% elif premio.recompensa == 'vale_trabalho' %}premio-bronze
                    {% else %}premio-comum
                    {% endif %}">
                    
                    <div class="premio-header">
                        <div class="premio-emoji">
                            {% if premio.recompensa == '10_reais' %}üí∞
                            {% elif premio.recompensa == '5_reais' %}üíµ
                            {% elif premio.recompensa == 'vale_trabalho' %}üìù
                            {% elif premio.recompensa == 'doce' %}üç≠
                            {% elif premio.recompensa == 'salgado' %}ü•®
                            {% endif %}
                        </div>
                        <div class="premio-valor">
                            {{ premio.get_recompensa_display }}
                        </div>
                    </div>
                    
                    <div class="premio-body">
                        <h5 class="premio-aluno">üë§ {{ premio.aluno.nome }}</h5>
                        <p class="premio-info">
                            <small>
                                <i class="fas fa-calendar"></i>
                                Ganho em: {{ premio.data_jogada|date:"d/m/Y" }}<br>
                                <i class="fas fa-clock"></i>
                                √Äs: {{ premio.data_jogada|date:"H:i:s" }}
                            </small>
                        </p>
                        
                        {% if premio.recompensa == '10_reais' or premio.recompensa == '5_reais' %}
                            <div class="premio-destaque">
                                <i class="fas fa-star"></i>
                                PR√äMIO EM DINHEIRO!
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="premio-footer">
                        <div class="row g-2">
                            <div class="col-8">
                                <button class="btn btn-success btn-lg w-100" 
                                        onclick="marcarResgatado({{ premio.id }})">
                                    <i class="fas fa-check"></i>
                                    ENTREGAR
                                </button>
                            </div>
                            <div class="col-4">
                                <button class="btn btn-danger btn-lg w-100" 
                                        onclick="excluirPremio({{ premio.id }}, '{{ premio.aluno.nome }}', '{{ premio.get_recompensa_display }}')"
                                        title="Excluir este pr√™mio">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="premio-badge">
                        {% if premio.recompensa == '10_reais' %}ü•á SUPER RARO
                        {% elif premio.recompensa == '5_reais' %}ü•à RARO
                        {% elif premio.recompensa == 'vale_trabalho' %}ü•â ESPECIAL
                        {% else %}üéØ COMUM
                        {% endif %}
                    </div>
                </div>
            </div>
        {% empty %}
            <div class="col-12">
                <div class="cyberpunk-card text-center py-5">
                    <div class="mb-4">
                        <i class="fas fa-gift fa-5x text-muted"></i>
                    </div>
                    <h3 class="text-muted">‚ú® Todos os pr√™mios foram entregues!</h3>
                    <p class="text-muted mb-4">
                        N√£o h√° nenhum pr√™mio aguardando resgate no momento.
                    </p>
                    <a href="{% url 'caca_niquel' %}" class="btn btn-primary btn-lg">
                        üé∞ Jogar Ca√ßa-N√≠quel
                    </a>
                </div>
            </div>
        {% endfor %}
    </div>
    
    <!-- Resumo de Valores -->
    {% if premios %}
        <div class="row mt-4">
            <div class="col-12">
                <div class="cyberpunk-card">
                    <h4 class="mb-3">üí∞ Resumo Financeiro dos Pr√™mios Pendentes</h4>
                    <div class="row">
                        <div class="col-md-3 text-center">
                            <div class="valor-card">
                                <h5 class="text-warning">üí∞ R$ 10,00</h5>
                                <p>{{ total_10_reais }} pr√™mio{{ total_10_reais|pluralize }}</p>
                            </div>
                        </div>
                        <div class="col-md-3 text-center">
                            <div class="valor-card">
                                <h5 class="text-info">üíµ R$ 5,00</h5>
                                <p>{{ total_5_reais }} pr√™mio{{ total_5_reais|pluralize }}</p>
                            </div>
                        </div>
                        <div class="col-md-3 text-center">
                            <div class="valor-card">
                                <h5 class="text-success">üç≠ü•® Lanches</h5>
                                <p>{{ total_lanches }} pr√™mio{{ total_lanches|pluralize }}</p>
                            </div>
                        </div>
                        <div class="col-md-3 text-center">
                            <div class="valor-card">
                                <h5 class="text-secondary">üìù Vale-trabalho</h5>
                                <p>{{ total_vale_trabalho }} pr√™mio{{ total_vale_trabalho|pluralize }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
</div>

<style>
.premio-card {
    background: linear-gradient(145deg, #2d3748, #1a202c);
    border-radius: 20px;
    padding: 0;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    border: 2px solid;
    transition: all 0.3s ease;
    position: relative;
}

.premio-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 40px rgba(0,0,0,0.4);
}

.premio-dourado {
    border-color: #ffd700;
    background: linear-gradient(145deg, #2d3748, #1a202c);
}

.premio-prata {
    border-color: #c0c0c0;
}

.premio-bronze {
    border-color: #cd7f32;
}

.premio-comum {
    border-color: #00d4ff;
}

.premio-header {
    background: rgba(0,0,0,0.3);
    padding: 20px;
    text-align: center;
    border-bottom: 1px solid rgba(255,255,255,0.1);
}

.premio-emoji {
    font-size: 3rem;
    margin-bottom: 10px;
}

.premio-valor {
    font-size: 1.2rem;
    font-weight: bold;
    color: #ffffff;
    text-shadow: 0 0 10px rgba(255,255,255,0.3);
}

.premio-body {
    padding: 20px;
    color: white;
}

.premio-aluno {
    color: #00d4ff;
    text-shadow: 0 0 10px rgba(0, 212, 255, 0.3);
    margin-bottom: 15px;
}

.premio-info {
    color: #cccccc;
    margin-bottom: 15px;
}

.premio-destaque {
    background: linear-gradient(90deg, #ff6b6b, #ffd700);
    color: #000;
    padding: 8px 12px;
    border-radius: 15px;
    text-align: center;
    font-weight: bold;
    font-size: 0.9rem;
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}

.premio-footer {
    padding: 20px;
    background: rgba(0,0,0,0.2);
}

.premio-badge {
    position: absolute;
    top: 15px;
    right: 15px;
    background: rgba(0,0,0,0.8);
    color: white;
    padding: 5px 10px;
    border-radius: 15px;
    font-size: 0.8rem;
    font-weight: bold;
}

.valor-card {
    background: rgba(0, 212, 255, 0.1);
    border: 1px solid rgba(0, 212, 255, 0.3);
    border-radius: 10px;
    padding: 20px;
    margin: 10px 0;
}

.valor-card h5 {
    margin-bottom: 10px;
    text-shadow: 0 0 10px rgba(255,255,255,0.3);
}

/* Efeitos especiais para pr√™mios raros */
.premio-dourado::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(45deg, transparent, rgba(255, 215, 0, 0.1), transparent);
    animation: shimmer 3s ease-in-out infinite;
    pointer-events: none;
}

.premio-prata::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(45deg, transparent, rgba(192, 192, 192, 0.1), transparent);
    animation: shimmer 4s ease-in-out infinite;
    pointer-events: none;
}

@keyframes shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
function marcarResgatado(jogadaId) {
    if (confirm('‚ö†Ô∏è Confirmar que este pr√™mio foi entregue ao aluno?\n\nEsta a√ß√£o n√£o pode ser desfeita!')) {
        // Feedback visual imediato
        const button = event.target;
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processando...';
        button.disabled = true;
        
        fetch(`/caca-niquel/marcar-resgatado/${jogadaId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.sucesso) {
                // Anima√ß√£o de sucesso
                button.innerHTML = '<i class="fas fa-check"></i> ENTREGUE!';
                button.className = 'btn btn-success btn-lg w-100';
                
                // Recarregar p√°gina ap√≥s anima√ß√£o
                setTimeout(() => {
                    location.reload();
                }, 1000);
            } else {
                alert('‚ùå Erro ao marcar como entregue: ' + (data.erro || 'Erro desconhecido'));
                button.innerHTML = originalText;
                button.disabled = false;
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('‚ùå Erro de conex√£o!');
            button.innerHTML = originalText;
            button.disabled = false;
        });
    }
}

// Fun√ß√£o para excluir um pr√™mio
function excluirPremio(jogadaId, nomeAluno, recompensa) {
    if (confirm(`‚ö†Ô∏è ATEN√á√ÉO!\n\nDeseja EXCLUIR permanentemente o pr√™mio?\n\nüë§ Aluno: ${nomeAluno}\nüéÅ Pr√™mio: ${recompensa}\n\n‚ö†Ô∏è Esta a√ß√£o N√ÉO pode ser desfeita!\nO pr√™mio ser√° removido do hist√≥rico.`)) {
        // Confirmar novamente para pr√™mios em dinheiro
        if (recompensa.includes('R$')) {
            if (!confirm(`üí∞ √öLTIMO AVISO!\n\nVoc√™ est√° prestes a EXCLUIR um pr√™mio EM DINHEIRO!\n\n${recompensa} para ${nomeAluno}\n\n‚ùå Esta a√ß√£o √© IRREVERS√çVEL!\n\nTem CERTEZA ABSOLUTA?`)) {
                return;
            }
        }
        
        const button = event.target;
        const originalHTML = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        button.disabled = true;
        
        fetch(`/caca-niquel/excluir-premio/${jogadaId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.sucesso) {
                // Feedback visual
                button.innerHTML = '<i class="fas fa-check"></i>';
                button.className = 'btn btn-secondary btn-lg w-100';
                
                // Recarregar p√°gina
                setTimeout(() => {
                    location.reload();
                }, 800);
            } else {
                alert('‚ùå Erro ao excluir pr√™mio: ' + (data.erro || 'Erro desconhecido'));
                button.innerHTML = originalHTML;
                button.disabled = false;
            }
        })
        .catch(error => {
            console.error('Erro:', error);
            alert('‚ùå Erro de conex√£o!');
            button.innerHTML = originalHTML;
            button.disabled = false;
        });
    }
}

// Efeito de confetes para pr√™mios especiais (opcional)
function celebrarPremio() {
    // Aqui poderia adicionar efeito de confetes ou celebra√ß√£o
    console.log('üéâ Pr√™mio entregue com sucesso!');
}
</script>
{% endblock %}
